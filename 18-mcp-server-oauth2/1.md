---
title: "Spring AI MCP Security 服务端（OAuth 2.1）"
date: 2026-02-03
slug: spring-ai-mcp-server-oauth2
categories: ["ai"]
tags: ['spring-ai', 'mcp', 'security', 'oauth2']
---

本文介绍如何使用 [spring-ai-community/mcp-security](https://github.com/spring-ai-community/mcp-security) 的 **MCP Server Security** 为 Spring AI MCP 服务端增加 **OAuth 2.0/2.1 JWT** 认证。示例 [18-mcp-server-oauth2](https://github.com/chensoul/spring-ai-samples/tree/main/18-mcp-server-oauth2) 使用 **Spring AI 1.1.x**、**spring-ai-starter-mcp-server-webmvc**（Streamable HTTP）、**mcp-server-security** 与 **Spring Security OAuth2 Resource Server**。授权服务器由 [17-mcp-authorization-server](https://github.com/chensoul/spring-ai-samples/tree/main/17-mcp-authorization-server) 提供。

<!--more-->

## 为什么用 OAuth 2.0/2.1

相比 API Key，OAuth 2.0/2.1 支持标准协议、JWT 校验、与现有身份体系集成。mcp-security 支持：

- **MCP Server Security**：OAuth 2.0 资源服务器（JWT）+ API Key。
- **MCP Client Security**：OAuth 2.0 客户端（Client Credentials、Authorization Code 等）。

本示例演示 **JWT 资源服务器** 方式，需先运行 17-mcp-authorization-server 作为 issuer。

## 项目结构

- **McpServerOAuth2Application**：Spring Boot 入口。
- **McpServerOAuth2SecurityConfig**：Security 配置，使用 `McpServerOAuth2Configurer.mcpServerOAuth2()`，指定 `issuer-uri`，并配置 CORS。测试时使用 `@Profile("!test")` 避免在无授权服务器时解析 issuer。
- **GreeterTools**：带 `@Tool` 的问候工具；**McpServerToolConfig** 通过 `MethodToolCallbackProvider` 注册为 MCP 工具。

## 依赖与配置

**pom.xml** 使用 Spring AI 1.1.x、WebMVC MCP 服务端、mcp-server-security、Spring Security、OAuth2 Resource Server：

```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-mcp-server-webmvc</artifactId>
</dependency>
<dependency>
    <groupId>org.springaicommunity</groupId>
    <artifactId>mcp-server-security</artifactId>
    <version>${mcp-security.version}</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

**application.properties** 要点：

```properties
spring.ai.mcp.server.protocol=STREAMABLE
spring.ai.mcp.server.streamable-http.mcp-endpoint=/mcp
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:9000
server.port=8090
```

## OAuth 2.0 安全配置

在 `McpServerOAuth2SecurityConfig` 中：

1. 使用 `McpServerOAuth2Configurer.mcpServerOAuth2()` 启用 OAuth2 资源服务器。
2. 通过 `mcp.authorizationServer(issuerUrl)` 指定授权服务器地址（与 `issuer-uri` 一致）。
3. `validateAudienceClaim(false)` 可根据实际 JWT 声明需求调整。
4. CORS 允许 `http://localhost:*`，便于浏览器/MCP Inspector 等访问。

```java
@Configuration
@EnableWebSecurity
@Profile("!test")
public class McpServerOAuth2SecurityConfig {
    @Value("${spring.security.oauth2.resourceserver.jwt.issuer-uri}")
    private String issuerUrl;

    @Bean
    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        return http
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .with(
                        McpServerOAuth2Configurer.mcpServerOAuth2(),
                        mcp -> {
                            mcp.authorizationServer(issuerUrl);
                            mcp.validateAudienceClaim(false);
                        }
                )
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                .build();
    }
    // ...
}
```

## 测试

单元测试使用 `@SpringBootTest(profiles = "test")` 并导入 `TestSecurityConfig`，在 test profile 下不加载 OAuth2 资源服务器配置，避免连接 18 授权服务器。

## 参考

- [Spring AI MCP Security - OAuth 2.0 Configuration](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-security.html)
- [mcp-security/samples](https://github.com/spring-ai-community/mcp-security/tree/main/samples)（OAuth2 服务端示例）
