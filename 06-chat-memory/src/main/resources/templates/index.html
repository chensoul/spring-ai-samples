<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">

</head>
<body>
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="chat-container position-relative">
                <!-- Chat Header -->
                <div class="chat-header d-flex align-items-center">
                    <div class="avatar">
                        <img src="/robot.svg" alt="Robot Avatar">
                    </div>
                    <div>
                        <h5 class="mb-0">ChatBot</h5>
                        <p class="mb-0"><span class="online-indicator"></span>Online</p>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Incoming Message -->
                    <div class="message d-flex incoming">
                        <div class="avatar">
                            <img src="/robot.svg" alt="Robot Avatar">
                        </div>
                        <div>
                            <div class="message-content">
                                Hi there! How can I help you today?
                            </div>
                            <div class="message-time">10:03 AM</div>
                        </div>
                    </div>

                </div>

                <!-- Chat Input -->
                <div class="chat-input">
                    <div class="input-group">
                        <textarea class="form-control message-textarea" placeholder="Type your message..." aria-label="Type your message"></textarea>
                        <button class="btn btn-primary" type="button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                                <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js" integrity="sha512-0pLmU2h0Q3z/yXlYqFStLx7dF2w2Y5eS5U6p0A4kqYQkzT+L/9FdCExNWx7gPJy2b5T2vM2A0FqFwEBBW3WJ+uw==" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous"></script>
<script>

    const robotSvg = `<img src="/robot.svg" alt="Robot Avatar">`;

    // 用户消息：转义 HTML，防止 XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function plainTextToHtml(text) {
        if (!text) return '<p></p>';
        text = String(text).trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\u2028/g, '\n').replace(/\u2029/g, '\n');
        var codeBlocks = [];
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(_, lang, code) {
            var i = codeBlocks.length;
            codeBlocks.push({ lang: lang, code: code.trim() });
            return '\n\n__CODEBLOCK_' + i + '__\n\n';
        });
        text = text.replace(/([：:。！!？?、])\s*-\s*/g, '$1\n- ').replace(/(- [^\n]+?) - /g, '$1\n- ');
        text = text.replace(/([^\n\s])-(?=[^\s\d\-a-zA-Z])/g, '$1\n- ');
        var paras = text.split(/\n\n+/);
        return paras.map(function(p) {
            p = p.trim();
            var m = p.match(/^__CODEBLOCK_(\d+)__$/);
            if (m) return '<pre><code>' + escapeHtml(codeBlocks[parseInt(m[1],10)].code) + '</code></pre>';
            var tableHtml = formatTableBlock(p);
            if (tableHtml) return tableHtml;
            return formatParagraphWithLists(p);
        }).join('') || '<p></p>';
    }
    function formatTableBlock(block) {
        var lines = block.split(/\n/).filter(function(l) { return l.trim().length > 0; });
        if (lines.length < 1) return '';
        var hasPipe = lines.every(function(l) { return /\|/.test(l); });
        if (!hasPipe) return '';
        var rows = lines.map(function(l) { return l.split(/\|/).slice(1, -1).map(function(c) { return c.trim(); }); });
        if (rows[0].length < 2) return '';
        var hasSep = rows.length > 1 && rows[1].every(function(c) { return /^[-:]+$/.test(c); });
        var header = rows[0];
        var bodyRows = hasSep ? rows.slice(2) : rows.slice(1);
        var html = '<table><thead><tr>';
        header.forEach(function(c) { html += '<th>' + escapeHtml(c) + '</th>'; });
        html += '</tr></thead><tbody>';
        bodyRows.forEach(function(row) {
            html += '<tr>';
            row.forEach(function(c) { html += '<td>' + escapeHtml(c) + '</td>'; });
            html += '</tr>';
        });
        html += '</tbody></table>';
        return html;
    }
    function formatParagraphWithLists(block) {
        block = block.trim();
        if (!block) return '';
        var lines = block.split(/\n/);
        var listLineRe = /^\s*[-*]\s*/;
        var out = [];
        var i = 0;
        while (i < lines.length) {
            if (listLineRe.test(lines[i]) && lines[i].replace(/^\s*[-*]\s*/, '').length > 0) {
                var listItems = [];
                while (i < lines.length && listLineRe.test(lines[i]) && lines[i].replace(/^\s*[-*]\s*/, '').length > 0) {
                    listItems.push(escapeHtml(lines[i].replace(/^\s*[-*]\s*/, '').trim()));
                    i++;
                }
                out.push('<ul>' + listItems.map(function(li) { return '<li>' + li + '</li>'; }).join('') + '</ul>');
            } else {
                var normal = [];
                while (i < lines.length && !listLineRe.test(lines[i])) {
                    normal.push(escapeHtml(lines[i]));
                    i++;
                }
                if (normal.length) out.push('<p>' + normal.join('<br>') + '</p>');
            }
        }
        return out.join('');
    }

    // AI 消息：Markdown 转 HTML 并做安全过滤；若库未加载或解析后无换行则退回按换行转 HTML
    function markdownToHtml(markdown) {
        if (!markdown || typeof markdown !== 'string') return '<p></p>';
        var text = String(markdown).trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\u2028/g, '\n').replace(/\u2029/g, '\n');
        if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') return plainTextToHtml(text);
        try {
            text = text.replace(/^(#{1,6})(?=[^\s#])/gm, '$1 ');
            text = text.replace(/([：:。！!？?、])\s*-\s*/g, '$1\n- ');
            text = text.replace(/(- [^\n]+?) - /g, '$1\n- ');
            text = text.replace(/([^\n\s])-(?=[^\s\d\-a-zA-Z])/g, '$1\n- ');
            marked.setOptions({ gfm: true, breaks: true });
            var rawHtml = marked.parse(text);
            if (!rawHtml) return plainTextToHtml(markdown);
            var out = DOMPurify.sanitize(rawHtml, { ALLOWED_TAGS: ['p','br','strong','em','u','s','code','pre','a','ul','ol','li','h1','h2','h3','h4','blockquote','hr','table','thead','tbody','tr','th','td'], ALLOWED_ATTR: ['href','target','rel','class','colspan','rowspan'] });
            if (text.indexOf('\n') !== -1 && out.indexOf('<br>') === -1 && out.indexOf('</p>') === -1) return plainTextToHtml(text);
            return out;
        } catch (e) {
            console.warn('Markdown parse failed:', e);
            return plainTextToHtml(markdown);
        }
    }

    // 添加一条消息；isOutgoing 为 true 时按纯文本展示，否则按 Markdown 渲染为 HTML
    function addMessage(content, isOutgoing = false) {
        const messagesContainer = document.getElementById('chatMessages');
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        const messageDiv = document.createElement('div');
        messageDiv.className = `message d-flex ${isOutgoing ? 'outgoing flex-row-reverse' : 'incoming'}`;

        const avatarContent = isOutgoing ? 'Me' : robotSvg;
        const bodyContent = isOutgoing ? escapeHtml(content) : markdownToHtml(content);
        const contentClass = isOutgoing ? 'message-content' : 'message-content markdown-content';

        messageDiv.innerHTML = `
                <div class="avatar">${avatarContent}</div>
                <div class="${isOutgoing ? 'text-end' : ''}">
                    <div class="${contentClass}">${bodyContent}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle auto-resize of textarea
    const textarea = document.querySelector('.message-textarea');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        // Set max height
        if (this.scrollHeight > 100) {
            this.style.height = '100px';
        }
    });

    // Add event listener to send button
    document.querySelector('.btn-primary').addEventListener('click', function() {
        const textarea = document.querySelector('.message-textarea');
        const message = textarea.value.trim();

        if (message) {
            addMessage(message, true);
            textarea.value = '';
            textarea.style.height = '50px'; // Reset height

            $.ajax('/api/chat', {
                type: 'POST',
                data: JSON.stringify({ prompt: message}),
                contentType: 'application/json'
            }).done(function(response) {
                    console.log("Success:", response);
                    addMessage(response.content);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Error:", textStatus, errorThrown);
                    alert("Error fetching data.");
                }
            );
        }
    });

    // Add event listener for pressing Enter key (without shift for newline)
    document.querySelector('.message-textarea').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevent default newline
            document.querySelector('.btn-primary').click();
        }
    });
</script>
</body>
</html>