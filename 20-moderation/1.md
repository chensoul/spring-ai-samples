---
title: "Spring AI 内容审核（Moderation）"
date: 2026-02-06
slug: spring-ai-moderation
categories: ["ai"]
tags: ['spring-ai']
---

本文介绍如何在 Spring AI 中使用 **内容审核（Moderation）**：对用户输入的文本进行安全检测，识别仇恨、骚扰、暴力、自伤、色情等违规内容。示例 [20-moderation](https://github.com/chensoul/spring-ai-samples/tree/main/20-moderation) 通过 **ModerationModel** 与 **ModerationPrompt** 实现文本审核并返回分类与得分；支持 **OpenAI** 与 **Mistral AI** 两种后端，可按配置或 Profile 切换。

<!--more-->

> **示例代码库**
>
> 您可以在 [GitHub 仓库](https://github.com/chensoul/spring-ai-samples/tree/main/20-moderation) 中找到本文的示例代码。

## 为什么需要内容审核

在聊天、评论、UGC 等场景中，需要对用户输入做合规与安全检测，避免违规内容进入下游（存储、展示、模型推理）。**Moderation** 的做法是：

1. **调用审核模型**：将待检测文本发给 Moderation API（本示例使用 OpenAI Moderation）。
2. **获取分类与得分**：返回是否被标记（flagged）、各违规类别（仇恨、骚扰、暴力、自伤、色情等）的布尔结果及 0–1 的置信度得分。
3. **业务决策**：根据 `flagged` 或各分类结果决定是否拒绝、记录或人工复核。

本示例支持两种 Moderation 后端：
- **OpenAI**（默认）：`spring-ai-starter-model-openai`，需 `OPENAI_API_KEY`。
- **Mistral AI**（可选）：需 Maven profile `-Pmistral` 引入 `spring-ai-starter-model-mistral-ai`，运行时激活 Spring profile `mistral` 并配置 `MISTRAL_AI_API_KEY`。

## 项目结构概览

- **Application**：Spring Boot 入口。
- **ModerationController**：`POST /api/moderate`，接收待审核文本，调用 `ModerationModel`，返回 `id`、`model`、`flagged` 及每条结果的 `categories` 与 `categoryScores`。

## 依赖与配置

**pom.xml** 默认引入 OpenAI；Mistral 通过 Maven profile `mistral` 可选引入（避免未配置 Mistral 时 Chat 自动配置报错）：

```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-model-openai</artifactId>
</dependency>
<!-- 使用 Mistral 时：mvn spring-boot:run -Pmistral -->
<profiles>
    <profile>
        <id>mistral</id>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-starter-model-mistral-ai</artifactId>
            </dependency>
        </dependencies>
    </profile>
</profiles>
```

**默认（OpenAI）** — `application.properties`：

```properties
spring.ai.model.moderation=openai
spring.ai.openai.api-key=${OPENAI_API_KEY}
# spring.ai.openai.moderation.options.model=text-moderation-latest
```

**Mistral** — 使用 profile `mistral`，或新建 `application-mistral.properties`：

```properties
spring.ai.model.moderation=mistral
spring.ai.mistralai.api-key=${MISTRAL_AI_API_KEY}
# spring.ai.mistralai.moderation.options.model=mistral-moderation-latest
```

- OpenAI 与 Mistral 的 Moderation 均为各自官方接口，需对应 API Key。
- 若需单独配置 Moderation 的 base-url、api-key，可使用 `spring.ai.openai.moderation.*` 或 `spring.ai.mistralai.moderation.*` 前缀。

## 使用 ModerationModel

注入 **ModerationModel**（由 Spring AI 根据 `spring.ai.model.moderation=openai` 自动配置），用 **ModerationPrompt** 传入待审核文本，调用 **call** 得到 **ModerationResponse**：

```java
@RestController
@RequestMapping("/")
class ModerationController {
    private final ModerationModel moderationModel;

    ModerationController(ModerationModel moderationModel) {
        this.moderationModel = moderationModel;
    }

    @PostMapping("/api/moderate")
    ModerateOutput moderate(@RequestBody @Valid ModerateInput input) {
        ModerationPrompt prompt = new ModerationPrompt(input.text());
        ModerationResponse response = moderationModel.call(prompt);
        Moderation moderation = response.getResult().getOutput();

        boolean flagged = false;
        List<Map<String, Object>> results = new ArrayList<>();
        for (ModerationResult result : moderation.getResults()) {
            flagged = flagged || result.isFlagged();
            // 将 categories、categoryScores 转为 Map 返回
            // ...
        }
        return new ModerateOutput(moderation.getId(), moderation.getModel(), flagged, results);
    }
}
```

- **ModerationResponse.getResult().getOutput()** 得到 **Moderation**，包含 `id`、`model` 和 **getResults()** 列表。
- 每个 **ModerationResult** 包含：
  - **isFlagged()**：该段是否被标记为违规。
  - **getCategories()**：各违规类别的布尔值（hate、harassment、selfHarm、sexual、violence 等）。
  - **getCategoryScores()**：各类别 0–1 的置信度得分。

常用类别包括：`sexual`、`hate`、`harassment`、`selfHarm`、`sexualMinors`、`hateThreatening`、`violenceGraphic`、`selfHarmIntent`、`selfHarmInstructions`、`harassmentThreatening`、`violence`。可根据业务只使用部分类别或设定阈值。

## 配置属性说明

**通用**：`spring.ai.model.moderation` 取值 `openai`、`mistral` 或 `none`，用于选择 Moderation 后端（默认 `openai`）。

**OpenAI**：`spring.ai.openai.api-key`、`spring.ai.openai.moderation.options.model`（默认 `text-moderation-latest`）等，见 [OpenAI Moderation](https://docs.spring.io/spring-ai/reference/api/moderation/openai-moderation.html)。

**Mistral**：`spring.ai.mistralai.api-key`、`spring.ai.mistralai.moderation.options.model`（默认 `mistral-moderation-latest`）等，见 [Mistral AI Moderation](https://docs.spring.io/spring-ai/reference/api/moderation/mistral-ai-moderation.html)。Mistral 还支持 Law、Financial、PII 等额外维度。

## 运行与测试

**默认（OpenAI）**：

```bash
export OPENAI_API_KEY=your-openai-api-key
cd 20-moderation && ../mvnw spring-boot:run
```

**使用 Mistral**（需先 `-Pmistral` 引入依赖）：

```bash
export MISTRAL_AI_API_KEY=your-mistral-api-key
cd 20-moderation && ../mvnw spring-boot:run -Pmistral -Dspring.profiles.active=mistral
```

**请求示例**：

```bash
curl -s -X POST http://localhost:8080/api/moderate \
  -H "Content-Type: application/json" \
  -d '{"text":"Hello, this is a normal message."}'
```

正常文本通常返回 `"flagged": false`。可尝试包含明显违规内容的文本观察 `flagged` 与各 `categories` / `categoryScores` 的变化。

## 小结

- Spring AI 通过 **ModerationModel**、**ModerationPrompt**、**ModerationResponse** 统一对接 Moderation，用于文本内容安全检测。
- 支持 **OpenAI** 与 **Mistral AI** 两种后端，通过 **spring.ai.model.moderation=openai|mistral** 及对应 API Key 启用。
- 根据 **ModerationResult** 的 **flagged**、**categories**、**categoryScores** 做业务侧拒绝、记录或人工复核。
