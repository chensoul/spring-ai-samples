---
title: "Spring AI MCP Security 服务端（API Key）"
date: 2026-02-03
slug: spring-ai-mcp-server-api-key
categories: ["ai"]
tags: ['spring-ai', 'mcp', 'security']
---

本文介绍如何使用 [spring-ai-community/mcp-security](https://github.com/spring-ai-community/mcp-security) 的 **MCP Server Security** 为 Spring AI MCP 服务端增加 **API Key** 认证。示例 [15-mcp-server-api-key](https://github.com/chensoul/spring-ai-samples/tree/main/15-mcp-server-api-key) 使用 **Spring AI 1.1.2**、**spring-ai-starter-mcp-server-webmvc**（Streamable HTTP）、**mcp-server-security** 与 **Spring Security**。配置方式与 [Spring AI MCP Security 官方文档](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-security.html)（API Key Authentication 一节）一致。

<!--more-->

> **说明**：mcp-security 为社区项目，非 Spring 官方；仅支持 **WebMVC** 服务端，不支持 WebFlux/STDIO 的 HTTP 安全。

## 为什么需要 MCP Security

MCP 服务若通过 HTTP 暴露，需要认证与授权。mcp-security 提供：

- **MCP Server Security**：OAuth 2.0 资源服务器 + API Key 认证。
- **MCP Client Security**：OAuth 2.0 客户端（授权码、客户端凭证、混合流）。

本示例仅演示 **API Key** 方式，避免搭建 OAuth2 授权服务器。

## 项目结构概览

- **McpSecurityServerApplication**：Spring Boot 入口。
- **McpServerSecurityConfig**：Security 配置，使用 `McpApiKeyConfigurer.mcpServerApiKey()` 与 `InMemoryApiKeyEntityRepository`。
- **GreeterTools**：带 `@Tool` 的问候工具；**McpServerToolConfig** 通过 `MethodToolCallbackProvider` 注册为 MCP 工具。
- **application.properties**：`spring.ai.mcp.server.protocol=STREAMABLE`、端点 `/mcp`。

## 依赖与配置

**pom.xml** 使用 Spring AI 1.1.2、WebMVC MCP 服务端、mcp-server-security 与 Spring Security：

```xml
<properties>
    <spring-ai.version>1.1.2</spring-ai.version>
    <mcp-security.version>0.0.6</mcp-security.version>
</properties>
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-mcp-server-webmvc</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springaicommunity</groupId>
        <artifactId>mcp-server-security</artifactId>
        <version>${mcp-security.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
</dependencies>
```

**application.properties** 要点：

```properties
spring.ai.mcp.server.protocol=STREAMABLE
spring.ai.mcp.server.name=mcp-server-api-key
spring.ai.mcp.server.streamable-http.mcp-endpoint=/mcp
```

## API Key 安全配置

在 `McpServerSecurityConfig` 中：

1. 使用 `McpApiKeyConfigurer.mcpServerApiKey()` 启用 API Key 认证。
2. 提供 `ApiKeyEntityRepository`：示例使用 `InMemoryApiKeyEntityRepository`，内置一个 `ApiKeyEntityImpl`（id=api01，secret=mycustomapikey，name 随意）。
3. 客户端请求头：`X-API-key: api01.mycustomapikey`（id.secret 格式）。可选：通过 `apiKey.headerName("CUSTOM-API-KEY")` 自定义头名，或 `apiKey.authenticationConverter(...)` 自定义从请求提取 API Key 的方式（如 `Authorization: Bearer <value>`）。

```java
@Configuration
@EnableWebSecurity
public class McpServerSecurityConfig {

    @Bean
    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        return http
                .authorizeHttpRequests(authz -> authz.anyRequest().authenticated())
                .with(
                        McpApiKeyConfigurer.mcpServerApiKey(),
                        apiKey -> apiKey.apiKeyRepository(apiKeyRepository())
                )
                .build();
    }

    private ApiKeyEntityRepository<ApiKeyEntity> apiKeyRepository() {
        ApiKeyEntity apiKey = ApiKeyEntityImpl.builder()
                .name("demo api key")
                .id("api01")
                .secret("mycustomapikey")
                .build();
        return new InMemoryApiKeyEntityRepository<>(List.of(apiKey));
    }
}
```

## 工具注册

WebMVC MCP 服务端通过 `ToolCallbackProvider` Bean 发现工具。使用 `MethodToolCallbackProvider` 将带 `@Tool` 的 `GreeterTools` 注册为 MCP 工具：

```java
@Configuration
public class McpServerToolConfig {
    @Bean
    ToolCallbackProvider greeterToolCallbackProvider(GreeterTools greeterTools) {
        return MethodToolCallbackProvider.builder()
                .toolObjects(greeterTools)
                .build();
    }
}
```

## 测试与客户端

- 单元测试：`McpSecurityServerApplicationTests` 仅做 context 加载。
- 客户端示例：**16-mcp-client-api-key** 通过 Streamable HTTP 连接本服务，并使用 `McpSyncHttpClientRequestCustomizer` 在请求头中附加 `X-API-key`。

## 已知限制（参见官方文档 Known Limitations）

- 已弃用的 SSE 传输不支持，请使用 [Streamable HTTP](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-streamable-http-server-boot-starter-docs.html) 或 [Stateless Streamable HTTP](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-stateless-server-boot-starter-docs.html)。
- 仅支持 **WebMVC** 服务端，不支持 WebFlux。
- Opaque 令牌不支持，需使用 JWT（OAuth2 时）。

## 参考

- [Spring AI MCP Security](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-security.html)（官方参考：MCP Server Security、API Key Authentication、Known Limitations）
- [mcp-security/samples](https://github.com/spring-ai-community/mcp-security/tree/main/samples)：官方示例，含 [sample-mcp-server-api-key](https://github.com/spring-ai-community/mcp-security/tree/main/samples/sample-mcp-server-api-key)（API Key + CORS）、[sample-mcp-server-secured-tools](https://github.com/spring-ai-community/mcp-security/tree/main/samples/sample-mcp-server-secured-tools)（仅工具调用需 OAuth2）等
- [mcp-security GitHub](https://github.com/spring-ai-community/mcp-security)
