---
title: "Spring AI MCP Security 客户端（API Key 请求头）"
date: 2026-02-03
slug: spring-ai-mcp-security-client
categories: ["ai"]
tags: ['spring-ai', 'mcp', 'security']
---

本文介绍如何让 Spring AI MCP 客户端连接使用 **API Key** 保护的 MCP 服务端（如 [15-mcp-server-api-key](https://github.com/chensoul/spring-ai-samples/tree/main/15-mcp-server-api-key)）。通过 MCP Java SDK 的 **McpSyncHttpClientRequestCustomizer** 在每次 HTTP 请求上添加 `X-API-key` 请求头。示例 [16-mcp-client-api-key](https://github.com/chensoul/spring-ai-samples/tree/main/16-mcp-client-api-key) 使用 **Spring AI 1.1.2**、**spring-ai-starter-mcp-client**（Streamable HTTP）。

<!--more-->

> **说明**：若服务端使用 OAuth 2.0，可参考 [Spring AI MCP Security - MCP Client Security](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-security.html) 使用 mcp-client-security 与 OAuth2 定制器（如 `OAuth2AuthorizationCodeSyncHttpRequestCustomizer`）；本示例仅演示通过同一 `McpSyncHttpClientRequestCustomizer` Bean 添加 API Key 头。

## 为什么需要请求定制器

MCP 服务端若使用 API Key 认证，要求客户端在**每个请求**的请求头中携带 API Key（如 `X-API-key: id.secret`）。Spring AI 的 Streamable HTTP 客户端在创建传输时会注入 **McpSyncHttpClientRequestCustomizer**（来自 `io.modelcontextprotocol.client.transport.customizer`），在发送前对 `HttpRequest.Builder` 进行定制，因此我们只需提供一个 Bean 实现该接口并在其中添加请求头即可。

## 项目结构概览

- **McpSecurityClientApplication**：Spring Boot 入口。
- **ApiKeyMcpRequestCustomizer**：配置类，提供 `McpSyncHttpClientRequestCustomizer` Bean，将 `mcp.security.api-key` 写入 `X-API-key` 请求头。
- **AskController**：提供 `/ask`，使用 ChatClient + MCP 工具（来自 15-mcp-server-api-key 的 greet 等）。
- **application.properties**：Streamable HTTP 连接（url、endpoint）、`mcp.security.api-key`、DeepSeek/OpenAI 配置。

## 依赖与配置

**pom.xml** 使用 Spring AI 1.1.2、MCP 客户端与 OpenAI 兼容模型：

```xml
<properties>
    <spring-ai.version>1.1.2</spring-ai.version>
</properties>
<dependencies>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-mcp-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-model-openai</artifactId>
    </dependency>
</dependencies>
```

**application.properties** 要点：

```properties
spring.ai.mcp.client.type=SYNC
spring.ai.mcp.client.streamable-http.connections.mcp-server-api-key.url=http://localhost:8080
spring.ai.mcp.client.streamable-http.connections.mcp-server-api-key.endpoint=/mcp
mcp.security.api-key=api01.mycustomapikey
```

## API Key 请求定制器

`McpSyncHttpClientRequestCustomizer` 来自 MCP Java SDK（`io.modelcontextprotocol.client.transport.customizer`），方法签名为：

```java
void customize(HttpRequest.Builder builder, String method, URI uri, String body, McpTransportContext context);
```

我们提供的 Bean 仅需在 `builder` 上添加 `X-API-key` 头：

```java
@Configuration
public class ApiKeyMcpRequestCustomizer {

    public static final String X_API_KEY_HEADER = "X-API-key";

    @Bean
    McpSyncHttpClientRequestCustomizer apiKeyRequestCustomizer(
            @Value("${mcp.security.api-key:api01.mycustomapikey}") String apiKey) {
        return (builder, method, uri, body, context) ->
                builder.header(X_API_KEY_HEADER, apiKey);
    }
}
```

Spring AI 的 Streamable HTTP 客户端自动配置会注入该 Bean，并在构建到 16-mcp-server-api-key 的请求时调用，从而通过服务端的 API Key 校验。

## 测试

单元测试中关闭 MCP 客户端（`spring.ai.mcp.client.enabled=false`、`toolcallback.enabled=false`），并提供一个空的 `ToolCallbackProvider`，仅做上下文加载，避免依赖本地 16 服务运行。

## 参考

- [Spring AI MCP Security](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-security.html)（MCP Client Security、HttpClient-Based Clients、McpSyncHttpClientRequestCustomizer）
- [mcp-security/samples](https://github.com/spring-ai-community/mcp-security/tree/main/samples)：官方示例，[sample-mcp-client](https://github.com/spring-ai-community/mcp-security/tree/main/samples/sample-mcp-client) 使用 OAuth2 + `OAuth2AuthorizationCodeSyncHttpRequestCustomizer`，本示例用同一 `McpSyncHttpClientRequestCustomizer` 接口添加 API Key 头
- [Spring AI MCP Client Boot Starter](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-client-boot-starter-docs.html)
