---
title: "Spring AI MCP Security 客户端（OAuth 2.1）"
date: 2026-02-03
slug: spring-ai-mcp-client-oauth2
categories: ["ai"]
tags: ['spring-ai', 'mcp', 'security', 'oauth2']
---

本文介绍如何使用 [spring-ai-community/mcp-security](https://github.com/spring-ai-community/mcp-security) 的 **MCP Client Security** 让 Spring AI MCP 客户端通过 **OAuth 2.0/2.1 Client Credentials** 获取 JWT 并访问受保护的 MCP 服务端。示例 [19-mcp-client-oauth2](https://github.com/chensoul/spring-ai-samples/tree/main/19-mcp-client-oauth2) 使用 **Spring AI 1.1.x**、**spring-ai-starter-mcp-client**、**mcp-client-security** 与 **Spring Security OAuth2 Client**。授权服务器与 MCP 服务端分别为 [17-mcp-authorization-server](https://github.com/chensoul/spring-ai-samples/tree/main/17-mcp-authorization-server) 与 [18-mcp-server-oauth2](https://github.com/chensoul/spring-ai-samples/tree/main/18-mcp-server-oauth2)。

<!--more-->

## 角色说明

- **17-mcp-authorization-server**：签发 JWT（issuer-uri: http://localhost:9000）。
- **18-mcp-server-oauth2**：MCP 资源服务器，校验 JWT，端口 8090。
- **19-mcp-client-oauth2**：本模块，使用 client_credentials 向 16 取 token，请求 17 时携带 Bearer token。

## 项目结构

- **McpClientOAuth2Application**：Spring Boot 入口。
- **McpOAuth2ClientConfig**：注册 `OAuth2ClientCredentialsSyncHttpRequestCustomizer`、`AuthenticationMcpTransportContextProvider`、`AuthorizedClientServiceOAuth2AuthorizedClientManager`（client_credentials）。
- **SecurityConfig**：启用 OAuth2 Client（oauth2Client）。
- **AskController**：Web 问答接口，调用 MCP 工具并配合 DeepSeek 生成回复。

## 依赖与配置

**pom.xml** 使用 Spring AI MCP Client、mcp-client-security、Spring Security OAuth2 Client：

```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-mcp-client</artifactId>
</dependency>
<dependency>
    <groupId>org.springaicommunity</groupId>
    <artifactId>mcp-client-security</artifactId>
    <version>${mcp-security.version}</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

**application.properties** 要点：

```properties
# MCP 服务端地址
spring.ai.mcp.client.streamable-http.connections.mcp-server-oauth2.url=http://localhost:8090
spring.ai.mcp.client.streamable-http.connections.mcp-server-oauth2.endpoint=/mcp

# OAuth2 Client Credentials
spring.security.oauth2.client.registration.mcp-client.client-id=mcp-client
spring.security.oauth2.client.registration.mcp-client.client-secret=mcp-client-secret
spring.security.oauth2.client.registration.mcp-client.authorization-grant-type=client_credentials
spring.security.oauth2.client.registration.mcp-client.provider=mcp-client
spring.security.oauth2.client.provider.mcp-client.issuer-uri=http://localhost:9000
```

## OAuth2 请求定制器

使用 mcp-client-security 提供的 `OAuth2ClientCredentialsSyncHttpRequestCustomizer`，配合 `AuthorizedClientServiceOAuth2AuthorizedClientManager` 与 registration id `mcp-client`，在每次请求 MCP 服务端时自动获取并附加 Bearer token：

```java
@Bean
McpSyncHttpClientRequestCustomizer oauth2RequestCustomizer(
        AuthorizedClientServiceOAuth2AuthorizedClientManager authorizedClientManager) {
    return new OAuth2ClientCredentialsSyncHttpRequestCustomizer(authorizedClientManager, "mcp-client");
}

@Bean
McpSyncClientCustomizer syncClientCustomizer() {
    return (name, syncSpec) -> syncSpec.transportContextProvider(new AuthenticationMcpTransportContextProvider());
}
```

## 测试

单元测试通过 `spring.ai.mcp.client.enabled=false` 与 `spring.ai.mcp.client.toolcallback.enabled=false` 关闭 MCP 客户端与工具回调，避免在无 18/19 时发起 OAuth2 与 MCP 请求，仅验证上下文加载。

## 参考

- [Spring AI MCP Security - MCP Client Security](https://docs.spring.io/spring-ai/reference/api/mcp/mcp-security.html)
- [mcp-security/samples](https://github.com/spring-ai-community/mcp-security/tree/main/samples)（OAuth2 客户端示例）
