<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat (SSE)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="chat-container position-relative">
                <div class="chat-header d-flex align-items-center">
                    <div class="avatar">
                        <img src="/robot.svg" alt="Robot Avatar">
                    </div>
                    <div>
                        <h5 class="mb-0">ChatBot (SSE)</h5>
                        <p class="mb-0"><span class="online-indicator"></span>Online</p>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message d-flex incoming">
                        <div class="avatar">
                            <img src="/robot.svg" alt="Robot Avatar">
                        </div>
                        <div>
                            <div class="message-content">
                                Hi there! Ask me anything — replies stream in real time.
                            </div>
                            <div class="message-time">—</div>
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <div class="input-group">
                        <textarea class="form-control message-textarea" placeholder="Type your message..." aria-label="Type your message"></textarea>
                        <button class="btn btn-primary btn-send" type="button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                                <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>
<!-- UMD 构建，保证 window.marked 可用 -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/lib/marked.umd.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous"></script>
<script>
(function() {
    const robotSvg = '<img src="/robot.svg" alt="Robot Avatar">';
    const SANITIZE_OPTIONS = {
        ALLOWED_TAGS: [
            'p','br','strong','em','u','s','code','pre','a','ul','ol','li',
            'h1','h2','h3','h4','h5','h6','blockquote','hr','table','thead',
            'tbody','tr','th','td','div','span','img','sup','sub','kbd'
        ],
        ALLOWED_ATTR: ['href','target','rel','class','colspan','rowspan','alt','title','src']
    };

    function sanitizeHtml(html) {
        if (!html) return '<p></p>';
        var purify = window.DOMPurify;
        if (!purify) return html;
        return purify.sanitize(html, SANITIZE_OPTIONS);
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function textToHtml(text) {
        if (!text) return '<p></p>';
        text = String(text).trim();
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\u2028/g, '\n').replace(/\u2029/g, '\n');
        var codeBlocks = [];
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(_, lang, code) {
            var i = codeBlocks.length;
            codeBlocks.push({ lang: lang, code: code.trim() });
            return '\n\n__CODEBLOCK_' + i + '__\n\n';
        });
        text = text.replace(/([：:。！!？?、])\s*-\s*/g, '$1\n- ');
        text = text.replace(/(- [^\n]+?) - /g, '$1\n- ');
        text = text.replace(/([^\n\s])-(?=[^\s\d\-a-zA-Z])/g, '$1\n- ');
        var paras = text.split(/\n\n+/);
        var html = paras.map(function(p) {
            p = p.trim();
            var m = p.match(/^__CODEBLOCK_(\d+)__$/);
            if (m) return '<pre><code>' + escapeHtml(codeBlocks[parseInt(m[1],10)].code) + '</code></pre>';
            var tableHtml = formatTableBlock(p);
            if (tableHtml) return tableHtml;
            return formatParagraphWithLists(p);
        }).join('');
        return html || '<p></p>';
    }
    function formatTableBlock(block) {
        var lines = block.split(/\n/).filter(function(l) { return l.trim().length > 0; });
        if (lines.length < 1) return '';
        var hasPipe = lines.every(function(l) { return /\|/.test(l); });
        if (!hasPipe) return '';
        var rows = lines.map(function(l) { return l.split(/\|/).slice(1, -1).map(function(c) { return c.trim(); }); });
        if (rows[0].length < 2) return '';
        var hasSep = rows.length > 1 && rows[1].every(function(c) { return /^[-:]+$/.test(c); });
        var header = rows[0];
        var bodyRows = hasSep ? rows.slice(2) : rows.slice(1);
        var html = '<table><thead><tr>';
        header.forEach(function(c) { html += '<th>' + escapeHtml(c) + '</th>'; });
        html += '</tr></thead><tbody>';
        bodyRows.forEach(function(row) {
            html += '<tr>';
            row.forEach(function(c) { html += '<td>' + escapeHtml(c) + '</td>'; });
            html += '</tr>';
        });
        html += '</tbody></table>';
        return html;
    }
    function formatParagraphWithLists(block) {
        block = block.trim();
        if (!block) return '';
        var lines = block.split(/\n/);
        var listLineRe = /^\s*[-*]\s*/;
        var out = [];
        var i = 0;
        while (i < lines.length) {
            if (listLineRe.test(lines[i]) && lines[i].replace(/^\s*[-*]\s*/, '').length > 0) {
                var listItems = [];
                while (i < lines.length && listLineRe.test(lines[i]) && lines[i].replace(/^\s*[-*]\s*/, '').length > 0) {
                    listItems.push(escapeHtml(lines[i].replace(/^\s*[-*]\s*/, '').trim()));
                    i++;
                }
                out.push('<ul>' + listItems.map(function(li) { return '<li>' + li + '</li>'; }).join('') + '</ul>');
            } else {
                var normal = [];
                while (i < lines.length && !listLineRe.test(lines[i])) {
                    normal.push(escapeHtml(lines[i]));
                    i++;
                }
                if (normal.length) out.push('<p>' + normal.join('<br>') + '</p>');
            }
        }
        return out.join('');
    }

    function markdownToHtml(markdown) {
        if (!markdown || typeof markdown !== 'string') return '<p></p>';
        var text = String(markdown).trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\u2028/g, '\n').replace(/\u2029/g, '\n');
        var md = window.marked;
        var hasPurify = !!window.DOMPurify;
        if (!md || !hasPurify) return textToHtml(markdown);
        try {
            text = text.replace(/^(#{1,6})(?=[^\s#])/gm, '$1 ');
            text = text.replace(/([：:。！!？?、])\s*-\s*/g, '$1\n- ');
            text = text.replace(/(- [^\n]+?) - /g, '$1\n- ');
            text = text.replace(/([^\n\s])-(?=[^\s\d\-a-zA-Z])/g, '$1\n- ');
            text = text.replace(/([^\n])\n(\s*[-*]\s+)/g, '$1\n\n$2');
            text = text.replace(/([^\n])\n(\s*\d+\.\s+)/g, '$1\n\n$2');
            text = text.replace(/(^|\n)(\s*[-*])(?=\S)/g, '$1$2 ');
            text = text.replace(/(^|\n)(\s*\d+\.)\s*(?=\S)/g, '$1$2 ');
            if (md.setOptions) md.setOptions({ gfm: true, breaks: true });
            var rawHtml = typeof md.parse === 'function' ? md.parse(text) : md(text);
            if (!rawHtml) return textToHtml(markdown);
            var out = sanitizeHtml(rawHtml);
            if (/\n\s*[-*]\s+/.test(text) && out.indexOf('<ul') === -1 && out.indexOf('<ol') === -1) {
                return textToHtml(markdown);
            }
            return out;
        } catch (e) {
            console.warn('markdownToHtml failed', e);
            return textToHtml(markdown);
        }
    }

    function addMessage(content, isOutgoing, options) {
        options = options || {};
        const messagesContainer = document.getElementById('chatMessages');
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message d-flex ' + (isOutgoing ? 'outgoing flex-row-reverse' : 'incoming');
        if (options.id) messageDiv.dataset.messageId = options.id;

        const avatarContent = isOutgoing ? 'Me' : robotSvg;
        const bodyContent = isOutgoing ? escapeHtml(content) : (options.raw ? content : markdownToHtml(content));
        const contentClass = 'message-content' + (isOutgoing ? '' : ' markdown-content') + (options.streaming ? ' streaming' : '');

        messageDiv.innerHTML =
            '<div class="avatar">' + avatarContent + '</div>' +
            '<div class="' + (isOutgoing ? 'text-end' : '') + '">' +
            '<div class="' + contentClass + '">' + bodyContent + '</div>' +
            '<div class="message-time">' + timeString + '</div>' +
            '</div>';

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return messageDiv;
    }

    function appendToMessageContent(messageDiv, text, isRaw) {
        const contentEl = messageDiv.querySelector('.message-content');
        if (!contentEl) return;
        if (isRaw) {
            contentEl.textContent = (contentEl.textContent || '') + text;
        } else {
            contentEl.innerHTML = contentEl.innerHTML + escapeHtml(text);
        }
    }

    function setMessageContent(messageDiv, html) {
        const contentEl = messageDiv.querySelector('.message-content');
        if (!contentEl) return;
        contentEl.classList.remove('streaming');
        contentEl.innerHTML = html;
    }

    async function sendStreamingMessage(prompt) {
        const messagesContainer = document.getElementById('chatMessages');
        const timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const messageId = 'msg-' + Date.now();

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message d-flex incoming';
        messageDiv.dataset.messageId = messageId;
        messageDiv.innerHTML =
            '<div class="avatar">' + robotSvg + '</div>' +
            '<div><div class="message-content markdown-content streaming"></div>' +
            '<div class="message-time">' + timeString + '</div></div>';
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const contentEl = messageDiv.querySelector('.message-content');
        let fullText = '';

        try {
            const res = await fetch('/api/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
            if (!res.ok) throw new Error(res.statusText);
            if (!res.body) throw new Error('No body');

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const events = buffer.split('\n\n');
                buffer = events.pop() || '';
                for (var i = 0; i < events.length; i++) {
                    var payload = events[i].replace(/^data: ?/gm, '');
                    fullText += payload;
                    contentEl.textContent = fullText;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }
            var payload = buffer.replace(/^data: ?/gm, '');
            fullText += payload;
            contentEl.textContent = fullText;
        } catch (e) {
            console.error(e);
            fullText = fullText || 'Error: ' + e.message || 'System business';
            contentEl.textContent = fullText;
        }

        contentEl.classList.remove('streaming');
        var html = markdownToHtml(String(fullText || ''));
        contentEl.innerHTML = html;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function sendMessage() {
        const textarea = document.querySelector('.message-textarea');
        const message = textarea.value.trim();
        if (!message) return;

        addMessage(message, true);
        textarea.value = '';
        textarea.style.height = '50px';

        sendStreamingMessage(message);
    }

    const textarea = document.querySelector('.message-textarea');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.scrollHeight > 100) this.style.height = '100px';
    });

    document.querySelector('.btn-send').addEventListener('click', sendMessage);
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
})();
</script>
</body>
</html>
